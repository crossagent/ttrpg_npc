# System Patterns: TTRPG NPC 模拟引擎 V4

## 1. 核心架构概述

本系统采用模块化设计，以 **游戏引擎 (Game Engine)** 为核心协调器，围绕 **游戏状态管理器 (Game State Manager)** 作为单一事实来源 (Single Source of Truth) 构建。核心交互通过 **代理管理器 (Agent Manager)** 调度不同类型的 **代理 (Agents)** 来实现，并通过 **消息分发器 (Message Dispatcher)** 处理通信。**叙事管理器 (Narrative Manager)** 负责结构化的剧本内容，而 **上下文构建器 (Context Builders)** 则负责格式化数据以供代理和展现层使用。

## 2. 主要模块及其职责

*   **游戏引擎 (Game Engine)**:
    *   **职责**: 总调度，管理游戏循环，协调各模块。
    *   **模式**: 中心协调器 (Central Coordinator)。
*   **代理管理器 & 代理 (Agent Manager & Agents)**:
    *   **职责**: 管理所有智能体（玩家、NPC、叙事、裁判）的生命周期和调度。实现“深度思考的 AI 角色”。
    *   **模式**: 代理模式 (Agent Pattern)，面向对象设计。
    *   **核心代理类型**:
        *   **玩家代理**: 代表人类玩家。
        *   **NPC 代理**: 模拟 NPC 思考（感知-思考-行动循环），包含目标、个性、观察、关系等内部状态。
        *   **叙事代理**: 负责生成环境描述、剧情叙述、NPC 对话（原 DM 叙事部分）。
        *   **裁判代理**: 负责解析行动意图、判定规则、判断事件触发、生成结构化状态变更指令（原 DM 规则部分）。**职责分离**: 将原 DM 职责拆分为叙事和裁判，提高模块清晰度。
*   **游戏状态管理器 (Game State Manager)**:
    *   **职责**: 存储和管理游戏世界状态（角色、环境、物品、事件进展）和全局消息历史。
    *   **模式**: 单一事实来源 (Single Source of Truth)，数据库模式。确保状态更新的原子性。
*   **叙事管理器 (Narrative Manager)**:
    *   **职责**: 管理结构化剧本内容（主线、支线、事件、场景、NPC 背景/目标）。实现“结构化的自由叙事”。
    *   **模式**: 内容管理系统 (CMS) / 剧本引擎。包含阶段推进 (`completion_criteria`) 和事件后果 (`consequence`) 的结构化定义。
*   **消息分发器 (Message Dispatcher)**:
    *   **职责**: 路由和分发消息，处理可见性过滤，连接逻辑层与展现层，管理消息历史。
    *   **模式**: 发布/订阅模式 (Publish/Subscribe)，消息队列。
*   **上下文构建器 (Context Builders)**:
    *   **职责**: 将结构化数据格式化为自然语言或 LLM Prompt。
    *   **模式**: 数据转换层 (Data Transformation Layer)，适配器模式 (Adapter Pattern)。
*   **展现层 (Presentation Layer)**:
    *   **职责**: 用户界面，显示信息，接收输入。
    *   **模式**: MVC/MVP 中的 View 层。

## 3. 关键交互模式与数据流

*   **回合制循环**: 由游戏引擎驱动，依次调度 DM/世界行动、玩家行动、NPC 反应阶段。
*   **状态驱动**: 代理的行为和叙事管理器的事件触发都基于当前游戏状态。
*   **消息驱动**: 模块间通过消息分发器进行通信和状态同步。
*   **LLM 集成**: NPC 代理、叙事代理、裁判代理利用 LLM 进行思考、生成和判断，上下文由构建器提供。
*   **结构化自由**: 叙事管理器提供剧本框架（阶段、事件、后果），裁判代理根据玩家/NPC 行动判断是否触发事件并应用后果，LLM 代理在此框架内动态生成内容和行为。
*   **游戏推进逻辑 (分布式)**:
    *   **裁判代理**: 解析行动，判定结果，判断事件触发，整合后果 (`consequence`)。
    *   **游戏状态管理器**: 应用后果，更新状态，检查并推进剧本阶段 (`stage`)。
    *   **叙事代理**: 根据更新后的状态生成描述。

## 4. 设计原则

*   **模块化与高内聚低耦合**: 各模块职责清晰，交互明确。
*   **单一职责原则**: 例如将 DM 拆分为叙事和裁判代理。
*   **数据驱动**: 游戏状态和剧本数据是核心。
*   **可扩展性**: 模块化设计便于未来添加新类型的代理、规则或交互方式。

*(此文件基于 docs/重要模块设计.md 生成)*
