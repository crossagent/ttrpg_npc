# 开发计划：裁判代理增强与游戏状态管理

本文档概述了增强裁判代理（Referee Agent）和游戏状态管理器（Game State Manager）功能的开发计划，旨在实现更完善的事件触发、后果处理和游戏进程管理。

## 当前状态总结

*   **裁判代理 (`RefereeAgent`)**: 目前主要依赖 LLM 直接判断行动的成功、叙述和基本状态变更 (`state_changes` 字典)，但**缺少**根据剧本进行事件触发判断、后果 (`consequence`) 提取与整合的逻辑。
*   **游戏状态管理器 (`GameStateManager`)**: 负责状态初始化和获取，但其 `update_state` 方法功能非常有限，**缺少**处理结构化后果列表、检查阶段完成条件 (`completion_criteria`) 和推进游戏阶段 (`advance_stage`) 的核心逻辑。同时，也缺少管理激活事件列表 (`active_event_ids`) 的机制。
*   **数据模型**:
    *   `ScenarioEvent` 定义了 `trigger_condition` 和 `possible_outcomes`，但 `EventOutcome` 中的 `consequence` 字段目前只是一个字符串，**需要结构化**。
    *   `StoryStage` **缺少**明确的 `completion_criteria` 字段。
    *   `GameState` **缺少** `active_event_ids` 列表。
    *   `ActionResult` 使用 `state_changes: Dict[str, Any]`，与设计文档中的 `consequence` 列表概念**需要统一**。

## 开发计划

### 阶段一：数据模型定义与完善 (Models Refinement)

此阶段的目标是建立清晰、一致的数据结构，为后续逻辑实现奠定基础。

1.  **定义结构化后果 (`Consequence`) 模型**:
    *   **目标**: 创建 Pydantic 模型来表示各种类型的状态变更后果。
    *   **位置**: 建议在 `src/models/game_state_models.py` 或创建一个新文件 `src/models/consequence_models.py`。
    *   **实现**: 使用 Pydantic 的 `BaseModel` 和 `Literal` (或 `Enum`) 定义一个基础 `BaseConsequence` 和多个具体的后果类，如 `GainItemConsequence`, `LoseItemConsequence`, `ChangeCharacterStateConsequence`, `ChangeLocationStateConsequence` 等。使用 `Union` 将它们组合成 `Consequence` 类型。
2.  **调整 `EventOutcome`**:
    *   **目标**: 使事件结局能包含结构化的后果列表。
    *   **位置**: `src/models/scenario_models.py`
    *   **修改**: 将 `EventOutcome` 模型中的 `consequence: str` 修改为 `consequences: List[Consequence]`。
    *   **更新**: 修改 `Scenario.from_json` 方法以正确解析 JSON 中定义的结构化后果。
3.  **为 `StoryStage` 添加 `completion_criteria`**:
    *   **目标**: 明确定义阶段完成的条件。
    *   **位置**: `src/models/scenario_models.py`
    *   **修改**: 在 `StoryStage` 模型中添加字段 `completion_criteria: Union[str, List[str]]`。
    *   **更新**: 修改 `Scenario.from_json` 方法以解析此字段。
4.  **为 `GameState` 添加 `active_event_ids`**:
    *   **目标**: 存储当前阶段激活的、可被触发的事件列表。
    *   **位置**: `src/models/game_state_models.py`
    *   **修改**: 在 `GameState` 模型中添加字段 `active_event_ids: List[str]`。
5.  **调整 `ActionResult`**:
    *   **目标**: 使行动结果能够携带结构化的后果列表。
    *   **位置**: `src/models/action_models.py`
    *   **修改**: 将 `ActionResult` 模型中的 `state_changes: Dict[str, Any]` 替换为 `consequences: List[Consequence]`。

### 阶段二：裁判代理增强 (Referee Agent Enhancement)

此阶段的目标是让裁判代理能够根据玩家行动判断是否触发事件，并整合输出后果。

1.  **更新 `judge_action`**: 修改方法签名和实现，使其返回包含 `consequences: List[Consequence]` 的 `ActionResult`。
2.  **实现事件触发检查**: 获取 `game_state.active_event_ids`，遍历并评估事件的 `trigger_condition` 是否被当前 `action` 满足。
3.  **实现结局确定**: 如果事件被触发，确定具体触发了哪个 `possible_outcomes`。
4.  **实现后果提取与整合**: 从确定的 `EventOutcome` 中提取 `consequences`。根据事件是否触发，整合行动本身的效果和事件后果，填充到 `ActionResult.consequences`。
5.  **调整 LLM Prompts**: 修改 Prompt 指示，让 LLM 专注于判断成功/失败和生成叙述，后果的生成/选择主要由 Python 代码处理。

### 阶段三：游戏状态管理器增强 (Game State Manager Enhancement)

此阶段的目标是让状态管理器能够根据后果更新状态，并管理游戏进程。

1.  **实现 `apply_consequences` 方法**: 创建核心方法处理 `List[Consequence]`，根据类型调用不同的私有处理方法。
2.  **重构 `update_state`**: 移除旧方法。
3.  **实现 `check_item`**: 检查角色物品。
4.  **实现 `check_stage_completion`**: 解析 `completion_criteria` 并检查是否满足。
5.  **实现 `advance_stage`**: 更新 `current_stage_id`，调用 `update_active_events`。
6.  **实现 `update_active_events`**: 根据当前阶段更新 `active_event_ids` 列表。
7.  **更新初始化逻辑**: 在初始化结束时调用 `update_active_events`。

### 阶段四：集成与测试 (Integration and Testing)

此阶段的目标是将修改后的模块整合到游戏循环中，并进行充分测试。

1.  **游戏引擎 (`GameEngine`) 集成**: 修改游戏循环，调用新方法处理后果、检查完成和推进阶段。
2.  **测试**: 编写单元测试和集成测试，验证功能正确性。
