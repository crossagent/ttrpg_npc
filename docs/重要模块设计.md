# TTRPG 核心模块设计 V4

本文档描述了单人 TTRPG 系统的高维度核心模块设计，重点说明各模块的职责、交互关系以及它们如何共同实现产品目标，特别是"深度思考的 AI 角色"和"结构化的自由叙事"这两个核心特性。

## 一、游戏引擎 (Game Engine / 总调度室)

### 模块职责
作为整个系统的核心驱动和协调者，游戏引擎负责管理游戏循环、调度其他模块、处理输入输出，确保游戏流程的顺畅运行。它是所有其他核心模块的中心枢纽，负责调用它们来完成回合内的各项任务。

### 核心功能
- **回合管理**：驱动游戏回合循环，协调 DM 阶段和玩家阶段的切换
- **模块调度**：根据游戏流程需要，调用其他核心模块完成特定任务
- **输入处理**：接收玩家输入，并将其传递给相应的处理模块
- **状态更新**：指示游戏状态管理器更新世界状态
- **输出生成**：通过消息分发器将游戏信息传递给展现层

### 与其他模块的交互
- 调用 **代理管理器** 触发 NPC、叙事代理和裁判代理的行动
- 与 **叙事管理器** 交互，检查和触发剧本事件
- 指示 **游戏状态管理器** 更新世界状态
- 通过 **消息分发器** 将信息传递给展现层
- 调用 **上下文构建器** 生成所需的格式化文本

## 二、代理管理器 & 代理 (Agent Manager & Agents / 角色与裁判部门)

### 模块职责
管理游戏中的所有"智能体"，包括玩家代理、NPC 代理、叙事代理和裁判代理。负责创建、存储、查找和调度这些代理。这是实现"深度思考的 AI 角色"的核心模块。

### 代理管理器功能
- **代理生命周期管理**：创建、初始化、存储和销毁代理
- **代理调度**：根据游戏引擎的指令，触发特定代理的感知、思考和行动
- **代理状态维护**：管理代理的内部状态，如 NPC 的目标、关系、记忆等

### 核心代理类型

#### 1. 玩家代理 (Player Agent)
- **职责**：代表人类玩家，传递玩家意图
- **核心功能**：
  - 接收玩家输入并传递给游戏引擎
  - 包含信息过滤逻辑，决定玩家能看到哪些信息
  - 维护玩家角色的状态和视角

#### 2. NPC 代理 (NPC Agent)
- **职责**：模拟 NPC 的独立思考和行动，实现"深度思考的 AI 角色"
- **核心功能**：
  - **感知 (Perceive)**: 从消息分发器获取其能感知到的信息
  - **思考 (Think)**:
    - 基于其**目标 (Goals)** (短期/长期，来自叙事管理器)
    - 基于其**个性 (Personality)** (预设特征，影响决策风格)
    - 基于其**观察记录 (Observations)** (对其他 Agent 行为的记忆和解读)
    - 基于其**关系状态 (Relationships)** (与其他 Agent 的友善度/敌对度等)
    - 进行推理与策略制定，决定下一步行动
  - **行动 (Act)**: 将思考结果转化为具体的游戏行动
  - 包含自身的信息过滤逻辑，决定能看到哪些信息
  - 能够主动采取行动或对事件做出反应，也可以选择暂时旁观

#### 3. 叙事代理 (Narrative Agent)
- **职责**：原 DM 代理的叙事职能，负责生成环境描述、剧情推进的叙述、NPC 对话等
- **核心功能**：
  - 根据当前游戏状态和剧情阶段，生成生动的场景描述
  - 创造沉浸式的游戏体验，运用感官描述增强游戏世界的真实感
  - 清晰呈现场景中的关键元素，包括环境、NPC 和可交互物品
  - 基于玩家行动反馈世界的变化，确保叙事的连贯性
  - 通过细节和氛围塑造适合当前情境的情绪基调

#### 4. 裁判代理 (Referee Agent)
- **职责**：原 DM 代理的规则裁判职能，负责解析玩家和 NPC 的行动意图，判断结果
- **核心功能**：
  - 接收玩家或 NPC 的行动意图（自然语言或半结构化）
  - 解析行动意图，理解玩家或 NPC 想要做什么
  - 根据游戏规则和当前状态判断行动是否成功、计算效果
  - 生成结构化的状态变更指令，如 `{"success": true, "narrative_hint": "成功打开了箱子", "state_changes": {"item_added": "金币", "location_state": "箱子已打开"}}`
  - 专注于"执行规则"和"判定结果"，而非叙事描述

### 与其他模块的交互
- 接收 **游戏引擎** 的调度指令
- 从 **游戏状态管理器** 获取当前世界状态
- 通过 **消息分发器** 获取可见的消息历史
- 使用 **上下文构建器** 格式化输入信息
- 向 **游戏引擎** 提交行动结果和状态变更请求

## 三、游戏状态管理器 (Game State Manager / 世界数据库)

### 模块职责
作为游戏世界状态的唯一真理来源 (Single Source of Truth)，负责存储和管理所有客观状态信息，包括角色状态、环境状态、物品状态、事件进展等。同时维护全局消息历史作为交互记录的完整存档。

### 核心功能
- **状态存储**：维护完整的游戏世界状态数据结构
- **状态查询**：提供高效的状态查询接口
- **原子化更新**：确保状态更新的一致性和原子性
- **历史记录**：维护全局消息历史，作为交互记录的完整存档

### 与其他模块的交互
- 接收 **游戏引擎** 的状态更新指令
- 为 **代理** 提供状态查询服务
- 为 **叙事管理器** 提供状态信息，用于评估事件触发条件
- 存储 **消息分发器** 传来的全局消息历史

## 四、叙事管理器 (Narrative Manager / 剧本与导演部)

### 模块职责
管理游戏的"结构化"部分，存储和维护主线剧情、支线任务、关键事件、场景转换条件、NPC 背景和目标等。根据游戏状态判断是否需要引入预设的剧情内容。这是实现"结构化的自由叙事"的核心模块。

### 核心功能
- **剧本存储**：维护完整的剧本结构，包括故事背景、章节、场景、事件等
- **触发条件评估**：根据当前游戏状态，评估是否满足剧情事件的触发条件
- **剧情推进**：在适当时机向游戏引擎提供需要引入的剧情内容
- **角色背景管理**：提供 NPC 的背景故事、初始目标和关系等信息

### 与其他模块的交互
- 接收 **游戏引擎** 的查询，检查是否有事件触发
- 从 **游戏状态管理器** 获取当前状态，用于评估触发条件
- 为 **NPC 代理** 提供角色背景和目标信息
- 为 **叙事代理** 提供当前阶段的剧情指导

## 五、消息分发器 (Message Dispatcher / 通信中心)

### 模块职责
负责游戏中所有消息的路由和分发，确保消息按照可见性规则正确传递给相关接收者。同时将消息存入全局历史，并连接逻辑层与展现层。

### 核心功能
- **消息路由**：根据消息类型和可见性规则，将消息分发给相应的接收者
- **可见性过滤**：调用代理的过滤逻辑，确定哪些消息对特定代理可见
- **历史管理**：将消息添加到全局历史，并提供按代理视角过滤的历史查询
- **UI 连接**：将需要显示的消息传递给展现层

### 与其他模块的交互
- 接收来自 **游戏引擎**、**代理** 和其他模块的消息
- 调用 **代理** 的过滤逻辑，确定消息可见性
- 更新 **代理** 的内部上下文
- 将消息存入 **游戏状态管理器** 的全局历史
- 将消息传递给 **展现层** 进行显示

## 六、上下文构建器 (Context Builders / 格式化与提示工程部)

### 模块职责
提供工具函数和逻辑，将结构化的游戏数据格式化成特定目标（如 LLM Prompt 或玩家界面文本）所需的文本格式。作为数据和自然语言之间的桥梁。它不负责管理信息可见性本身，而是处理已经被代理或消息分发器过滤后的信息。

### 核心功能
- **数据格式化**：将结构化数据转换为自然语言描述或 LLM 提示
- **上下文组装**：根据不同代理的需求，组装合适的上下文信息
- **提示工程**：为 LLM 代理（如叙事代理、裁判代理、NPC 代理）构建有效的提示模板

### 与其他模块的交互
- 从 **游戏状态管理器** 获取结构化数据
- 从 **消息分发器** 获取过滤后的消息历史
- 为 **代理**（特别是 LLM 驱动的代理）提供格式化的上下文
- 为 **展现层** 提供格式化的文本描述

## 七、展现层 (Presentation Layer / Chat/UI)

### 模块职责
负责向用户展示游戏信息，是玩家与游戏系统交互的界面。接收来自消息分发器的消息和数据，以合适的格式呈现给最终用户。

### 核心功能
- **消息显示**：以适当的格式显示游戏消息（对话、系统提示、行动结果等）
- **状态展示**：显示玩家角色的状态、物品、任务等信息
- **输入接收**：接收玩家的文本输入或 UI 操作，并传递给游戏引擎
- **视觉呈现**：根据需要提供视觉元素（如界面、图标、可能的简单图形等）

### 实现形式
- 当前：控制台文本界面
- 未来：图形用户界面（GUI）、Web 界面等

### 与其他模块的交互
- 从 **消息分发器** 接收需要显示的消息
- 将玩家输入传递给 **游戏引擎**
- 可能使用 **上下文构建器** 提供的格式化文本

## 八、回合流程详解

### 1. DM/世界行动阶段 (DM/World Action Phase)
- **游戏引擎** 启动回合
- **游戏引擎** 请求 **叙事管理器** 检查是否有强制性剧本事件需要触发
- 如果有强制事件：
  - **叙事管理器** 返回事件信息
  - **游戏引擎** 指示 **代理管理器** 激活 **叙事代理**
  - **上下文构建器** 为 **叙事代理** 提供格式化的上下文
  - **叙事代理** 生成叙事描述
  - **游戏引擎** 将叙事通过 **消息分发器** 发送给 **展现层**
- 如果无强制事件：
  - **游戏引擎** 可能激活所有相关 **NPC 代理** 和 **玩家代理** 进行感知
  - **消息分发器** 为每个代理提供其可见的近期消息历史和 **游戏状态** 变化
  - **上下文构建器** 可能辅助格式化这些信息
  - 每个 **NPC 代理** 执行 `think` 过程，根据其目标、个性和当前状况，可能决定采取行动，也可能决定暂时旁观/观察
  - **玩家代理** 接收信息，等待玩家决策
  - 如果 NPC 决定行动：
    - **NPC 代理** 将行动意图提交给 **游戏引擎**
    - **游戏引擎** 指示 **代理管理器** 激活 **裁判代理**
    - **裁判代理** 解析行动并判定结果
    - **游戏引擎** 指示 **游戏状态管理器** 更新状态
    - **游戏引擎** 可能指示 **叙事代理** 生成描述
    - 结果通过 **消息分发器** 发送给 **展现层**
  - 如果所有 NPC 都选择旁观，且无强制事件，此阶段可能只产生简单的环境描述或无明显动作

### 2. 玩家行动阶段 (Player Action Phase)
- **展现层** 接收玩家输入并传递给 **游戏引擎**
- **游戏引擎** 指示 **代理管理器** 激活 **裁判代理**
- **裁判代理** 解析玩家意图并判定结果
- **游戏引擎** 指示 **游戏状态管理器** 更新状态
- **游戏引擎** 可能指示 **叙事代理** 生成描述
- 结果通过 **消息分发器** 发送给 **展现层**

### 3. NPC 反应阶段 (NPC Reaction Phase)
- **游戏引擎** 判断哪些 NPC 可能对玩家行动做出反应
- **游戏引擎** 指示 **代理管理器** 激活相关 **NPC 代理**
- **消息分发器** 提供上下文 (基于 Agent 过滤)
- 每个 **NPC 代理** 感知、思考并决定是否反应
- 如果 NPC 决定反应：
  - **NPC 代理** 将行动意图提交给 **游戏引擎**
  - **游戏引擎** 指示 **代理管理器** 激活 **裁判代理**
  - **裁判代理** 解析行动并判定结果
  - **游戏引擎** 指示 **游戏状态管理器** 更新状态
  - **游戏引擎** 可能指示 **叙事代理** 生成描述
  - 结果通过 **消息分发器** 发送给 **展现层**

### 4. 回合结束
- **游戏引擎** 更新回合计数
- **游戏引擎** 准备进入下一回合的 DM/世界行动阶段

## 九、游戏推进判断模块 (Game Progression Logic - 分布式)

游戏推进并非由单一模块完成，而是多个模块协作的结果，主要涉及**行动解析**和**后果驱动**两个方面。

### 行动解析与裁判
- 由 **裁判代理 (Referee Agent)** 核心负责
- 接收玩家或 NPC 的行动意图（自然语言或半结构化）
- 利用 LLM 或规则引擎进行解析、判定成功与否、计算效果
- 输出结构化的结果，如 `{"success": true, "narrative_hint": "成功打开了箱子", "state_changes": {"item_added": "金币", "location_state": "箱子已打开"}}`

### 剧情推进
- **裁判代理** 判定的结果（特别是 `state_changes`）由 **游戏引擎** 应用到 **游戏状态管理器**
- **游戏状态** 的变化触发 NPC 反应 (通过 **代理管理器** 和 **NPC 代理**)
- **游戏状态** 的变化或特定动作触发结构化叙事 (通过 **叙事管理器**)
- **叙事代理** 可能会根据 **裁判代理** 返回的 `narrative_hint` 和上下文，生成更丰富的叙事描述
